name: Update Product Data

on:
  schedule:
    # Runs every 12 hours (at minute 0 of hour 0 and 12)
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create public directory
        run: |
          mkdir -p public

      - name: Fetch from Cloudinary API
        env:
          CLOUDINARY_CLOUD_NAME: 'pearlmart'
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${CLOUDINARY_API_KEY}:${CLOUDINARY_API_SECRET}" \
            -d '{"expression":"folder:products-admin","with_field":["context"],"max_results":30}' \
            "https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/resources/search")
          
          # Count products
          PRODUCT_COUNT=$(echo "$RESPONSE" | jq '.resources | length')
          echo "Data fetched successfully. Found $PRODUCT_COUNT products."
          
          # Save raw response
          echo "$RESPONSE" > public/products_raw.json

      - name: Install jq if needed
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Generate products.json with unique metadata
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          PRETTY_TIME=$(date +"%Y-%m-%d %H:%M:%S UTC")
          RANDOM_ID=$(openssl rand -hex 8)
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          RUN_ID="${{ github.run_id }}-${{ github.run_attempt }}"
          
          echo "Generating products.json with unique metadata..."
          echo "Timestamp: $TIMESTAMP"
          echo "Random ID: $RANDOM_ID"
          echo "Run ID: $RUN_ID"
          
          if [ -f "public/products_raw.json" ]; then
            # Create products.json with ALWAYS unique metadata
            jq --arg ts "$TIMESTAMP" \
               --arg ptime "$PRETTY_TIME" \
               --arg rid "$RANDOM_ID" \
               --arg hash "$COMMIT_HASH" \
               --arg run "$RUN_ID" \
               --argjson count $(jq '.resources | length' public/products_raw.json) \
               '. + {
                  metadata: {
                    last_updated: $ts,
                    last_updated_human: $ptime,
                    total_products: $count,
                    source: "Cloudinary API",
                    update_type: "scheduled",
                    update_id: $rid,
                    git_commit: $hash,
                    workflow_run: $run,
                    generated_at: "'$(date +%s)'"
                  }
                }' public/products_raw.json > public/products.json
            
            echo "âœ… Generated products.json with update_id: $RANDOM_ID"
            echo "File size: $(wc -c < public/products.json) bytes"
          else
            echo "ERROR: products_raw.json was not created!"
            exit 1
          fi

      - name: Show data preview
        run: |
          if [ -f "public/products.json" ]; then
            echo "=== Data Preview ==="
            echo "Metadata:"
            jq -r '.metadata' public/products.json
            echo ""
            echo "Total products: $(jq '.resources | length' public/products.json)"
          else
            echo "ERROR: products.json was not created!"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "github-action-bot@users.noreply.github.com"

      - name: Update and commit changes
        run: |
          # Pull latest changes first
          echo "Step 1: Pulling latest changes..."
          git pull origin main
          
          # Check if file exists and get its current state
          echo "Step 2: Checking current state..."
          if [ -f "public/products.json" ]; then
            OLD_UPDATE_ID=$(jq -r '.metadata.update_id' public/products.json 2>/dev/null || echo "none")
            echo "Current file update_id: $OLD_UPDATE_ID"
          else
            echo "No existing products.json found"
          fi
          
          # Get the new update_id from our generated file
          NEW_UPDATE_ID=$(jq -r '.metadata.update_id' public/products.json 2>/dev/null || echo "unknown")
          echo "New file update_id: $NEW_UPDATE_ID"
          
          # Always add and commit the file (it's always unique due to random ID)
          echo "Step 3: Adding file to Git..."
          git add public/products.json
          
          # Check if there are actual changes
          echo "Step 4: Checking for changes..."
          if git diff --cached --quiet; then
            echo "âš ï¸ No changes detected by git diff, but we'll commit anyway..."
            # Force a change by modifying the file slightly
            echo "// This ensures a unique commit - Update ID: $NEW_UPDATE_ID" >> public/products.json
            git add public/products.json
          fi
          
          # Commit with detailed message
          echo "Step 5: Committing..."
          COMMIT_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          PRODUCT_COUNT=$(jq '.resources | length' public/products.json 2>/dev/null || echo "0")
          
          git commit -m "ðŸ“¦ Update product data [$COMMIT_TIME]" \
                     -m "Update ID: $NEW_UPDATE_ID" \
                     -m "Total products: $PRODUCT_COUNT" \
                     -m "Workflow run: ${{ github.run_number }}"
          
          echo "Step 6: Pushing changes..."
          git push origin main
          
          echo "âœ… Successfully updated!"
          echo "ðŸ• Time: $COMMIT_TIME"
          echo "ðŸ†” Update ID: $NEW_UPDATE_ID"
          echo "ðŸ“Š Products: $PRODUCT_COUNT"

      - name: Clean up
        run: |
          rm -f public/products_raw.json 2>/dev/null || true
          echo "Cleanup done"

      - name: Final verification
        run: |
          echo "=== FINAL VERIFICATION ==="
          echo "File status:"
          ls -la public/products.json
          echo ""
          echo "Current time: $(date)"
          echo "File metadata:"
          jq -r '.metadata | "Last updated: \(.last_updated_human)\nUpdate ID: \(.update_id)\nWorkflow run: \(.workflow_run)"' public/products.json
          echo ""
          echo "Latest commit:"
          git log --oneline -3
