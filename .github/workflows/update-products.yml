name: Update Product Data

on:
  schedule:
    # Runs every 12 hours (at minute 0 of hour 0 and 12)
    - cron: '0 */12 * * *'
  # Also runs when you manually trigger it
  workflow_dispatch:
  # Runs when you push to the main branch
  push:
    branches: [ main ]

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # This ensures we have the complete history
          fetch-depth: 0
          # Use --force option to allow overwriting
          ref: main

      - name: Create public directory
        run: |
          # Create the public directory if it doesn't exist
          mkdir -p public

      - name: Fetch from Cloudinary API
        env:
          CLOUDINARY_CLOUD_NAME: 'pearlmart'
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          # Use curl to call the Cloudinary API
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${CLOUDINARY_API_KEY}:${CLOUDINARY_API_SECRET}" \
            -d '{"expression":"folder:products-admin","with_field":["context"],"max_results":30}' \
            "https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/resources/search")
          
          # Save the response as a JSON file
          echo "$RESPONSE" > public/products.json
          
          # Print a preview (install jq first)
          echo "Data fetched successfully. Found $(echo $RESPONSE | jq '.resources | length') products."

      - name: Check if jq is installed
        run: |
          if ! command -v jq &> /dev/null; then
            echo "jq not found, installing..."
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Show data preview
        run: |
          if [ -f "public/products.json" ]; then
            echo "First product preview:"
            jq -r '.resources[0] | {public_id, secure_url, context}' public/products.json
          else
            echo "ERROR: products.json was not created!"
            exit 1
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "github-action-bot@users.noreply.github.com"
          
          # Always add the file
          git add public/products.json
          
          # Check if there are actual changes in content
          if git diff --cached --quiet; then
            echo "No actual changes in content"
          else
            # Force update to avoid conflicts
            git pull --rebase origin main || echo "Local changes, proceeding with commit"
            git commit -m "Update product data [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push --force
            echo "Changes committed and pushed"
          fi
