name: Update Product Data

on:
  schedule:
    # Runs every 12 hours (at minute 0 of hour 0 and 12)
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create public directory
        run: |
          mkdir -p public

      - name: Fetch from Cloudinary API
        env:
          CLOUDINARY_CLOUD_NAME: 'pearlmart'
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${CLOUDINARY_API_KEY}:${CLOUDINARY_API_SECRET}" \
            -d '{"expression":"folder:products-admin","with_field":["context"],"max_results":30}' \
            "https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/resources/search")
          
          echo "$RESPONSE" > public/products.json
          echo "Data fetched successfully. Found $(echo $RESPONSE | jq '.resources | length') products."

      - name: Install jq if needed
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Show data preview
        run: |
          if [ -f "public/products.json" ]; then
            echo "First product preview:"
            jq -r '.resources[0] | {public_id, secure_url, context}' public/products.json
          else
            echo "ERROR: products.json was not created!"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "github-action-bot@users.noreply.github.com"

      - name: Commit and push
        run: |
          # Reset to remote main to avoid conflicts
          git fetch origin
          git reset --hard origin/main
          
          # Add and commit the updated file
          git add public/products.json
          
          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Update product data [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push origin main
            echo "Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
