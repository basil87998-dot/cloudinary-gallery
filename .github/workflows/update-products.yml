name: Update Product Data

on:
  schedule:
    # Runs every 12 hours (at minute 0 of hour 0 and 12)
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create public directory
        run: |
          mkdir -p public

      - name: Fetch from Cloudinary API
        env:
          CLOUDINARY_CLOUD_NAME: 'pearlmart'
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${CLOUDINARY_API_KEY}:${CLOUDINARY_API_SECRET}" \
            -d '{"expression":"folder:products-admin","with_field":["context"],"max_results":30}' \
            "https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/resources/search")
          
          # Count products
          PRODUCT_COUNT=$(echo "$RESPONSE" | jq '.resources | length')
          echo "Data fetched successfully. Found $PRODUCT_COUNT products."
          
          # Save raw response
          echo "$RESPONSE" > public/products_raw.json

      - name: Install jq if needed
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Generate products.json with ALWAYS unique content
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          PRETTY_TIME=$(date +"%Y-%m-%d %H:%M:%S UTC")
          RANDOM_ID=$(openssl rand -hex 4)
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          
          echo "Generating products.json with:"
          echo "  Timestamp: $TIMESTAMP"
          echo "  Random ID: $RANDOM_ID"
          echo "  Commit: $COMMIT_HASH"
          
          if [ -f "public/products_raw.json" ]; then
            # Create products.json with ALWAYS unique metadata
            jq --arg ts "$TIMESTAMP" \
               --arg ptime "$PRETTY_TIME" \
               --arg rid "$RANDOM_ID" \
               --arg hash "$COMMIT_HASH" \
               --argjson count $(jq '.resources | length' public/products_raw.json) \
               '. + {
                  metadata: {
                    last_updated: $ts,
                    last_updated_human: $ptime,
                    total_products: $count,
                    source: "Cloudinary API",
                    update_type: "scheduled",
                    update_id: $rid,
                    git_commit: $hash,
                    workflow_run: "'${{ github.run_id }}'",
                    run_attempt: "'${{ github.run_attempt }}'"
                  }
                }' public/products_raw.json > public/products.json
            
            echo "âœ… Generated products.json with unique update_id: $RANDOM_ID"
          else
            echo "ERROR: products_raw.json was not created!"
            exit 1
          fi

      - name: Show data preview
        run: |
          if [ -f "public/products.json" ]; then
            echo "=== Data Preview ==="
            echo "Metadata:"
            jq -r '.metadata' public/products.json
            echo ""
            echo "Total products: $(jq '.resources | length' public/products.json)"
          else
            echo "ERROR: products.json was not created!"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "github-action-bot@users.noreply.github.com"

      - name: Force update with ALWAYS new content
        run: |
          # First, delete the existing file from Git's index
          echo "Step 1: Removing existing file from Git index..."
          git rm --cached public/products.json 2>/dev/null || true
          
          # Pull latest changes
          echo "Step 2: Pulling latest changes..."
          git pull origin main --rebase --autostash || echo "Pull may have conflicts, continuing..."
          
          # Delete any existing products.json
          echo "Step 3: Deleting existing file..."
          rm -f public/products.json public/products.json.bak 2>/dev/null || true
          
          # Now move our newly generated file into place
          echo "Step 4: Moving new file into place..."
          if [ -f "public/products.json" ]; then
            echo "File already exists, comparing..."
            OLD_HASH=$(git hash-object public/products.json 2>/dev/null || echo "none")
            NEW_HASH=$(git hash-object public/products_raw_processed.json 2>/dev/null || echo "none")
            echo "Old hash: $OLD_HASH"
            echo "New hash: $NEW_HASH"
          fi
          
          # Add the new file
          echo "Step 5: Adding new file to Git..."
          git add -f public/products.json
          
          # Check for actual changes using git diff
          echo "Step 6: Checking for changes..."
          if ! git diff --cached --name-only | grep -q "public/products.json"; then
            echo "âš ï¸ Git doesn't see changes in the file"
            echo "Forcing a change by adding a comment..."
            # Add a unique comment to the file
            UPDATE_ID=$(jq -r '.metadata.update_id' public/products.json)
            echo "// Auto-generated at $(date) - Update ID: $UPDATE_ID" > public/products.comment
            cat public/products.comment public/products.json > public/products.json.tmp
            mv public/products.json.tmp public/products.json
            git add -f public/products.json
          fi
          
          # Always commit (even if Git doesn't see changes)
          echo "Step 7: Committing changes..."
          COMMIT_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          UPDATE_ID=$(jq -r '.metadata.update_id' public/products.json 2>/dev/null || echo "manual-$(date +%s)")
          PRODUCT_COUNT=$(jq '.resources | length' public/products.json 2>/dev/null || echo "0")
          
          git commit -m "ðŸ”„ Update product data [$COMMIT_TIME]" \
                     -m "Update ID: $UPDATE_ID" \
                     -m "Products: $PRODUCT_COUNT items" \
                     -m "Workflow: ${{ github.workflow }} #${{ github.run_number }}" \
                     --allow-empty
          
          echo "Step 8: Pushing changes..."
          git push origin main
          
          echo "âœ… Successfully updated at $COMMIT_TIME"
          echo "ðŸ“Š Update ID: $UPDATE_ID"
          echo "ðŸ“¦ Products: $PRODUCT_COUNT"

      - name: Clean up temporary files
        run: |
          rm -f public/products_raw.json public/products.comment 2>/dev/null || true
          echo "Cleanup complete"

      - name: Final verification
        run: |
          echo "=== FINAL VERIFICATION ==="
          echo "Current UTC time: $(date -u +"%Y-%m-%d %H:%M:%S")"
          echo ""
          echo "File info:"
          ls -la public/products.json
          echo ""
          echo "Metadata from file:"
          jq -r '.metadata | "Last Updated: \(.last_updated_human)\nUpdate ID: \(.update_id)\nProducts: \(.total_products)"' public/products.json
          echo ""
          echo "Latest commit:"
          git log --oneline -1
